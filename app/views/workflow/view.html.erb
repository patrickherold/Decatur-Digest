<h1><%= @workflow.name %> - Workflow Details</h1>

<p><%= @workflow.description %></p>

<table class="table table-striped table-hover table-condensed">
  <thead>
  <tr>
    <th>Property Address</th>
    <th class="hidden-sm hidden-xs">Owner Name</th>
    <th class="visible">Appraised</th>
    <th class="visible-md visible-lg">Appeal Value</th>
    <th class="visible-lg">Zoning</th>
    <th class="visible-lg">Homestead</th>
    <th class="hidden-xs">Lot Details</th>
    <th>Workflow Status</th>
    <th></th>
  </tr>
  </thead>
  <tbody>
  <% @workflow.lots.each { |lot| %>
      <% status = @workflow.status_by_lot(lot) %>
      <tr>
        <td><%= lot.property_street if lot.property_street_and_number.present? %></td>
        <td class="hidden-sm hidden-xs"><%= lot.owners_name if lot.owner.present? %></td>
        <td class="visible"><%= number_to_currency(lot.appraised_appraised, :unit => "$", :precision => 0) %></td>
        <% if lot.appeal_value.to_i > 10 %>
            <td class="visible-md visible-lg">
              <div class="btn btn-danger btn-xs"><%= number_to_currency(lot.full_appeal, :unit => "$", :precision => 0) %></div>
            </td>
        <% else %>
            <td class="visible-md visible-lg"><%= number_to_currency(lot.full_appeal, :unit => "$", :precision => 0) %></td>
        <% end %>
        <td class="visible-lg"><%= lot.zoning %></td>
        <td class="visible-lg"><%= lot.homestead %></td>
        <td>
          <% if number_with_precision lot.reputation_for(:votes) >= 1 %>
              <%= link_to "Details", lot_path(lot.id), :redirect_to => "/lot/#{lot.id}", :class => "btn btn-warning btn-xs" %>
          <% elsif number_with_precision lot.reputation_for(:votes) >= 5 %>
              <%= link_to "Details", lot_path(lot.id), :redirect_to => "/lot/#{lot.id}", :class => "btn btn-danger btn-xs" %>
          <% else %>
              <%= link_to "Details", lot_path(lot.id), :redirect_to => "/lot/#{lot.id}", :class => "btn btn-info btn-xs" %>
          <% end %>
        </td>
        
        <td class="workflow-status">
          <% if !status || status[:status] == 'pending' %>
              <span class="status-label label label-default">pending</span>
          <% elsif status[:status] == 'ok' %>
              <span class="label label-success">ok</span>
          <% elsif status[:status] == 'problem' %>
              <span class="label label-warning">problem</span>
          <% elsif status[:status] == 'escalate' %>
              <span class="label label-danger">escalate</span>
          <% elsif status[:status] == 'appeal' %>
              <span class="label label-danger">appeal</span>
          <% end %>
          <div class="status-popover" style="display: none">
            <h3>Property Inspection Status</h3>

            <div class="viewer">
              <% if status %>
                  <table>
                    <tr>
                      <td class="key">
                        Status
                      </td>
                      <td>
                        <% if status[:status] == 'pending' %>
                            <span class="label label-default">undefined</span>
                        <% elsif status[:status] == 'ok' %>
                            <span class="label label-success">ok</span>
                        <% elsif status[:status] == 'problem' %>
                            <span class="label label-warning">problem</span>
                        <% elsif status[:status] == 'escalate' %>
                            <span class="label label-danger">escalate</span>
                        <% elsif status[:status] == 'appeal' %>
                            <span class="label label-danger">appeal</span>
                        <% end %>
                      </td>
                    </tr>
                    <tr>
                      <td class="key">
                        Message
                      </td>
                      <td>
                        <%= status ? status[:message] : '' %>
                      </td>
                    </tr>
                    <tr>
                      <td class="key">
                        By
                      </td>
                      <td>
                        <%= status[:user].name %>
                      </td>
                    </tr>
                    <tr>
                      <td class="key">
                        Timestamp
                      </td>
                      <td>
                        <%= l status[:timestamp], :format => :login_date %>
                      </td>
                    </tr>
                  </table>
                  <div class="bottom-buttons">
                    <a href="#" class="bottom-button btn btn-warning btn-xs" onclick="$(this).parent().parent().parent().find('.editor').show(); $(this).parent().parent().hide(); return false;">Re-evaluate</a>
                    <a href="#" class="bottom-button btn btn-danger btn-xs" onclick="$(this).parent().parent().parent().slideUp(150); return false;">Close</a>
                  </div>
              <% else %>
                  Status: <span class="label label-default">pending</span>

                  <div class="bottom-buttons">
                    <a href="#" class="bottom-button btn btn-warning btn-xs" onclick="$(this).parent().parent().parent().find('.editor').show(); $(this).parent().parent().hide(); return false;">Evaluate</a>
                    <a href="#" class="bottom-button btn btn-danger btn-xs" onclick="$(this).parent().parent().parent().slideUp(150); return false;">Close</a>
                  </div>
              <% end %>
            </div>
            <div class="editor" style="display: none">
              <%= form_tag do %>
                  <table>
                    <tr>
                      <td class="key">
                        Status
                      </td>
                      <td>
                        <%= select_tag "status_#{lot.id}", options_for_select(%w'pending problem ok escalate appeal') %>
                      </td>
                    </tr>
                    <tr>
                      <td class="key">
                        Message
                      </td>
                      <td>
                        <%= text_area_tag "message_#{lot.id}" %>
                      </td>
                    </tr>
                    <tr>
                      <td></td>
                      <td>
                        <%= submit_tag 'Save', :class => 'btn btn-success btn-xs' %>
                        <a href="#" onclick="$(this).parents().find('.editor').parent().find('.viewer').show(); $(this).parents().find('.editor').hide(); return false;" class="btn btn-warning btn-xs">Cancel</a>
                      </td>
                    </tr>
                  </table>
              <% end %>
            </div>
          </div>
        </td>
        <td>
          <%= link_to 'Remove from workflow', remove_from_workflow_path(@workflow, lot), :confirm => 'Are you sure?', :class => 'btn btn-danger btn-xs' %>
        </td>
      </tr>
  <% } %>
  </tbody>
</table>

<% if @workflow.user == current_user %>
    <%= link_to 'Edit Workflow Details', edit_workflow_path(@workflow), :class => 'btn btn-warning' %>
    &nbsp;
    <%= link_to 'Delete Workflow', delete_workflow_path(@workflow), :class => 'btn btn-danger' %>
<% end %>

<script>
    $('.status-label').click(function (event) {
        var was_visible = $(event.currentTarget).parent().find('.status-popover').is(':visible');
        $('.status-popover').hide();
        if (!was_visible)
            $(event.currentTarget).parent().find('.status-popover').slideDown(200);
    });
</script>